---
# ================== PURPOSE ==================
# Run All Playbook (with Intrusion Detection)
# - Orchestrates baseline, hardening, detection, etc.
# - Provides a single entry point for competition initialization
# - Posts completion notice to Discord
# =============================================
# USAGE:
#   ansible-playbook playbooks/run_all_with_detection.yml
#   ansible-playbook playbooks/run_all_with_detection.yml --skip-tags detection

- import_playbook: pre_check.yml
  tags: [pre_check]

- import_playbook: baseline.yml
  tags: [baseline]

- import_playbook: hardening.yml
  tags: [hardening]

- import_playbook: pass_reset.yml
  tags: [pass_reset]

# NEW: Deploy intrusion detection
- import_playbook: deploy_detection.yml
  tags: [detection]

- import_playbook: scoring_validation.yml
  tags: [scoring]

- name: Final notification
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Post run_all completion
      ansible.builtin.uri:
        url: "{{ discord_webhook_url }}"
        method: POST
        body_format: json
        body:
          content: "üèÅ **Full Deployment Complete**\n‚úÖ Baseline configured\n‚úÖ Systems hardened\n‚úÖ Passwords reset\n‚úÖ Intrusion detection active\n‚úÖ Services validated\n**Time:** {{ lookup('pipe','date') }}"
        status_code: [200, 204]
      when: discord_webhook_url is defined
      ignore_errors: true
      tags: [notify, passive]