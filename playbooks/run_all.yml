---
# ================== PURPOSE ==================
# Run All Playbook
# - Orchestrates baseline, hardening, validation, etc.
# - Provides a single entry point for competition initialization
# - Posts completion notice to Discord
# =============================================
# - Run with: ansible-playbook playbooks/run_all.yml --vault-password-file ~/.vault_pass
# - Purpose: Orchestrates all major playbooks in sequence
# - Tags: notify, passive
# - Notes: Each playbook posts its own Discord notification; run_all adds a final summary ping
# =============================================

- import_playbook: pre_check.yml
  vars:
    message: "🛠️ pre_check.yml completed"

- import_playbook: baseline.yml
  vars:
    message: "📦 baseline.yml completed"

- import_playbook: hardening.yml
  vars:
    message: "🛡️ hardening.yml completed"

- import_playbook: pass_reset.yml
  vars:
    message: "🔑 pass_reset.yml completed"

- import_playbook: scoring_validation.yml
  vars:
    message: "📊 scoring_validation.yml completed"

- import_playbook: incident_response.yml
  vars:
    message: "🚨 incident_response.yml completed"

- import_playbook: rollback.yml
  vars:
    message: "⚠️ rollback.yml executed (if triggered)"

- name: Final notification
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Post run_all completion
      ansible.builtin.uri:
        url: "{{ discord_webhook_url }}"
        method: POST
        body_format: json
        body:
          content: "🏁 run_all.yml completed at {{ lookup('pipe','date') }}"
        status_code: 204
      when: discord_webhook_url is defined
      ignore_errors: true
      tags: [notify, passive]
