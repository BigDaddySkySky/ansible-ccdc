---
# ================== PURPOSE ==================
# Run All Playbook (with Intrusion Detection)
# - Orchestrates baseline, hardening, detection, etc.
# - Provides a single entry point for competition initialization
# - Posts completion notice to Discord
# =============================================
# USAGE:
#   ansible-playbook playbooks/run_all.yml
#   ansible-playbook playbooks/run_all.yml --skip-tags detection

- name: Pre-Competition Checks
  import_playbook: pre_check.yml
  tags: [pre_check]

- name: Baseline Configuration
  import_playbook: baseline.yml
  tags: [baseline]

- name: System Hardening
  import_playbook: hardening.yml
  tags: [hardening]

- name: Password Reset
  import_playbook: pass_reset.yml
  tags: [pass_reset]

- name: Deploy Intrusion Detection
  import_playbook: deploy_detection.yml
  tags: [detection]

- name: Scoring Validation
  import_playbook: scoring_validation.yml
  tags: [scoring]

- name: Final notification
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Post run_all completion
      ansible.builtin.uri:
        url: "{{ discord_webhook_url }}"
        method: POST
        body_format: json
        body:
          content: >-
            🏁 **Full Deployment Complete**
            ✅ Baseline configured
            ✅ Systems hardened
            ✅ Passwords reset
            ✅ Intrusion detection active
            ✅ Services validated
            **Time:** {{ lookup('pipe', 'date') }}
        status_code: [200, 204]
      when: discord_webhook_url is defined
      failed_when: false
      tags: [notify, passive]
