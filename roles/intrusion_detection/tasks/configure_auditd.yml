---
# ================== PURPOSE ==================
# Configure Enhanced Auditd Rules
# - Monitors sensitive file access
# - Tracks privilege escalation attempts
# - Logs suspicious system calls
# =============================================

- name: Ensure auditd is installed
  ansible.builtin.package:
    name: audit
    state: present

- name: Create CCDC audit rules directory
  ansible.builtin.file:
    path: /etc/audit/rules.d
    state: directory
    mode: '0750'

- name: Deploy CCDC audit rules
  ansible.builtin.copy:
    dest: /etc/audit/rules.d/ccdc-detection.rules
    content: |
      # CCDC Intrusion Detection Audit Rules
      # Generated by Ansible - Manual edits will be overwritten

      ## Monitor authentication files
      -w /etc/passwd -p wa -k passwd_changes
      -w /etc/shadow -p wa -k shadow_changes
      -w /etc/sudoers -p wa -k sudoers_changes
      -w /etc/ssh/sshd_config -p wa -k sshd_config_changes

      ## Monitor privileged commands
      -a always,exit -F arch=b64 -S execve -F euid=0 -k root_commands
      -a always,exit -F arch=b32 -S execve -F euid=0 -k root_commands

      ## Monitor network connections (potential reverse shells)
      -a always,exit -F arch=b64 -S socket -S connect -k network_connections
      -a always,exit -F arch=b32 -S socket -S connect -k network_connections

      ## Monitor file deletion
      -a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -k file_deletion
      -a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -k file_deletion

      ## Monitor privilege escalation
      -a always,exit -F arch=b64 -S setuid -S setgid -S setreuid -S setregid -k privilege_escalation
      -a always,exit -F arch=b32 -S setuid -S setgid -S setreuid -S setregid -k privilege_escalation

      ## Monitor kernel module loading
      -w /sbin/insmod -p x -k kernel_modules
      -w /sbin/rmmod -p x -k kernel_modules
      -w /sbin/modprobe -p x -k kernel_modules

      ## Monitor cron jobs
      -w /etc/cron.allow -p wa -k cron_changes
      -w /etc/cron.deny -p wa -k cron_changes
      -w /etc/cron.d/ -p wa -k cron_changes
      -w /etc/cron.daily/ -p wa -k cron_changes
      -w /etc/cron.hourly/ -p wa -k cron_changes
      -w /etc/cron.monthly/ -p wa -k cron_changes
      -w /etc/cron.weekly/ -p wa -k cron_changes
      -w /var/spool/cron/ -p wa -k cron_changes
    mode: '0640'
  notify: Restart auditd

- name: Enable auditd service
  ansible.builtin.service:
    name: auditd
    enabled: true
    state: started

- name: Load audit rules immediately
  ansible.builtin.command: auditctl -R /etc/audit/rules.d/ccdc-detection.rules
  changed_when: false
  failed_when: false
